L.TileLayer.WMTS=L.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixSet:"",format:"image/jpeg"},initialize:function(t,e){this._url=t;var i=L.extend({},this.defaultWmtsParams),r=e.tileSize||this.options.tileSize;e.detectRetina&&L.Browser.retina?i.width=i.height=2*r:i.width=i.height=r;for(var n in e)"serverType"!=n&&(this.options.hasOwnProperty(n)||"matrixIds"==n||(i[n]=e[n]));this.wmtsParams=i,this.matrixIds=e.matrixIds||this.getDefaultMatrix(),L.setOptions(this,e)},onAdd:function(t){L.TileLayer.prototype.onAdd.call(this,t)},getTileUrl:function(t){var e=this._map;crs=e.options.crs,tileSize=this.options.tileSize,nwPoint=t.multiplyBy(tileSize),nwPoint.x+=1,nwPoint.y-=1;var i=this._getZoomForUrl();return sePoint=nwPoint.add(new L.Point(tileSize,tileSize)),nw=crs.project(e.unproject(nwPoint,i)),se=crs.project(e.unproject(sePoint,i)),tilewidth=se.x-nw.x,ident=this.matrixIds[i].identifier,X0=this.matrixIds[i].topLeftCorner.lng,Y0=this.matrixIds[i].topLeftCorner.lat,tilecol=Math.floor((nw.x-X0)/tilewidth),tilerow=-Math.floor((nw.y-Y0)/tilewidth),url=L.Util.template(this._url,{s:this._getSubdomain(t)}),"geoserver"===this.options.serverType&&(ident=this.options.tilematrixSet+":"+ident),url+L.Util.getParamString(this.wmtsParams,url)+"&tilematrix="+ident+"&tilerow="+tilerow+"&tilecol="+tilecol},setParams:function(t,e){return L.extend(this.wmtsParams,t),e||this.redraw(),this},getDefaultMatrix:function(){for(var t=new Array(22),e=0;e<22;e++)t[e]={identifier:""+e,topLeftCorner:new L.LatLng(90,-180)};return t}}),L.tileLayer.wmts=function(t,e){return new L.TileLayer.WMTS(t,e)};